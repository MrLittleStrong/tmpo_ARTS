### 背景

静态分析，可以帮助我们在编写代码阶段及时发现代码错误，从而在根儿上保证工程质量。

Xcode自带的静态分析工具Analyze，通过静态语法分析能找出内存泄漏及无用变量的问题。有一定的局限性，现在有功能更全，定制化高，效率高的第三方静态检查工具，如OCLint，Infer，Clang静态分析器。

### 优缺点

#### 优点

- 发现人工测试的盲点
- 提高检查问题的效率
- 寻找潜在的可用性问题，如空指针访问，资源和内存泄漏等，还得能检查代码规范和代码可维护性的问题。
- 检查代码规范，找出哪些代码需要优化。

> 复杂度指标包括三个：
>
> - 圈复杂度高。圈复杂度指的是遍历一个模块时的复杂度，这个复杂度由控制语句，运算符及决策点共同决定（如 if、else，&&、||等），4以内为低，5-7是中，8-10是高，11以上就需要考虑重构了。
> - NPath复杂度高。NPath度指的是一个方法所有可能执行的路径数量，一般高于200要考虑降低复杂度。
> - NCSS度高。NCSS度值不包含注释的源码行数。一般方法行数不过百，类的行数不过千。

#### 缺点

- 耗时长。包含了编译最耗时的IO和语法分析阶段，而且静态分析内容要比编译多，所以无论如何优化都会比编译时间要长。
- 只能监察处专门设计好的、可查找的错误，对于特定类型的错误分析，还需要开发者自己写插件加进去。

### 三种主流分析工具对比

#### OCLint

OCLint基于Clang Tooling开发的静态分析工具，用来发现编译器检查不到的潜在的关键技术问题。

基本覆盖了通用的规则，包括语法上的基础规则，Cocoa库相关规则，约定俗成的规则，空余局检查，是否按照新语法改写的检查，命名上长变量名短变量名、无用语句和参数检查。

还包括代码量是否合理的规则，如过大的类，方法是否过多，参数是否过多，Block嵌套是否太深，方法里代码是否过多，圈复杂度的检查等。

#### Clang静态分析器

Clang静态分析器用C++开发的，用来分析C，C++和OC的开源工具，是Clang项目的一部分，构建在Clang和LLVM上。

常用的就是**scan-build和scan-view**两个工具。

scan-build使用来运行分析器的命令行工具；scan-view包含了scan-build工具，会在scan-build结束后将结果可视化。

scan-build原理是，将编译器构建改为一个“假的”编译器来构建，这个编译器会执行Clang编译，然后执行静态分析器分析你的代码。

Clang静态分析器由分析引擎和checkers组成的。checker都是基于底层分析引擎之上的。通过分析引擎提供的功能，我们可以编写自己的checker。

这种架构可以方便我们扩展我们的检查项规则。

#### Infer

Infer是Facebook开源的，使用OCaml语言写的静态分析工具，可以对C，Java，OC进行代码分析，可以检查空指针访问，资源泄漏及内存泄漏。

Infer的安装有从源码安装和直接安装binary releases两种方式。

Infer工作流程：

- 转化阶段。将源代码转为Infer内部的中间语言。类C语言使用Clang编译，Java使用Javac编译，编译的同时转为中间语言，输出到infer-out目录。
- 分析阶段。分析infer-out目录下的文件。分析每个方法，如果有错误记录出错的位置，继续分析下个方法，最后将所有的地方进行汇总输出。
- 检查结果输出为JSON格式，放到report.json文件内。

### 比较

Clang静态分析器和Xcode集成度高，也支持命令行。不过检查规则少，基本上只能检查出较大的问题，如类型转换，而对内存泄漏问题检查的侧重点在于可用性。

OClint检查规则多，定制性强，能够发现很多潜在问题，但缺点在于检查规则过多，可定制度过高。

Infer效率高，支持增量分析，可小范围分析。

综合比较，Infer在准确性，性能效率，规则，扩展性，易用性整体度上把握做的最好，比较推荐Infer。

